#!/usr/bin/env bash
# Pre-push hook: Runs build and tests before allowing push
# Install: git config core.hooksPath .githooks

set -e

# Skip on Claude Code web sessions to avoid timeout issues
# CI/CD will run the same validations after push
if [[ "$CLAUDE_CODE_REMOTE" == "true" ]]; then
    echo "Skipping pre-push hook (web session - CI will validate)"
    exit 0
fi

echo "Running pre-push validations..."

# Check if dotnet is available
if ! command -v dotnet &> /dev/null; then
    echo "Error: dotnet CLI not found. Please install .NET SDK."
    exit 1
fi

# Restore dependencies
echo "Restoring dependencies..."
if ! dotnet restore --verbosity minimal; then
    echo ""
    echo "Push rejected: Failed to restore dependencies."
    exit 1
fi

# Build the solution
echo "Building solution..."
if ! dotnet build --no-restore --configuration Release --verbosity minimal; then
    echo ""
    echo "Push rejected: Build failed."
    echo ""
    echo "Fix the build errors and try again."
    exit 1
fi

# Run tests
echo "Running tests..."
if ! dotnet test --no-build --configuration Release --verbosity minimal; then
    echo ""
    echo "Push rejected: Tests failed."
    echo ""
    echo "Fix the failing tests and try again."
    exit 1
fi

echo "Pre-push validations passed."
